name: beembeem_workflow_runner
on:
  - event: slack.message
steps:
  - id: check_run_request
    if: "{{ 'run workflow' in event.text|lower or 'execute workflow' in event.text|lower }}"
    use: core.echo
    with:
      text: "Processing workflow run request"
  - id: extract_workflow_name
    use: openai.chat_completion
    with:
      model: "gpt-4o"
      messages:
        - role: system
          content: |
            Extract the workflow name from the user's request to run a workflow.
            
            If they mention a specific workflow name, return just that name.
            If they don't specify, return "list" to show available workflows.
            
            Examples:
            "run workflow daily_standup" -> "daily_standup"
            "execute the email_reminder workflow" -> "email_reminder"
            "run a workflow" -> "list"
            
            Return ONLY the workflow name or "list".
        - role: user
          content: "{{ event.text }}"
  - id: list_workflows
    if: "{{ extract_workflow_name.choices.0.message.content == 'list' }}"
    use: beembeem.list_workflows
  - id: reply_list
    if: "{{ extract_workflow_name.choices.0.message.content == 'list' }}"
    use: slack.chat.postMessage
    with:
      channel: "{{ event.channel }}"
      text: "Available workflows:\n{% for workflow in list_workflows.workflows %}• {{ workflow }}\n{% endfor %}\nTo run one: 'run workflow <name>'"
      thread_ts: "{{ event.thread_ts or event.timestamp }}"
  - id: run_workflow
    if: "{{ extract_workflow_name.choices.0.message.content != 'list' }}"
    use: beembeem.run_workflow
    with:
      name: "{{ extract_workflow_name.choices.0.message.content }}"
  - id: reply_run_success
    if: "{{ extract_workflow_name.choices.0.message.content != 'list' and run_workflow.success }}"
    use: slack.chat.postMessage
    with:
      channel: "{{ event.channel }}"
      text: "✅ Started workflow '{{ extract_workflow_name.choices.0.message.content }}' (Run ID: {{ run_workflow.run_id }})"
      thread_ts: "{{ event.thread_ts or event.timestamp }}"
  - id: reply_run_error
    if: "{{ extract_workflow_name.choices.0.message.content != 'list' and not run_workflow.success }}"
    use: slack.chat.postMessage
    with:
      channel: "{{ event.channel }}"
      text: "❌ Failed to run workflow '{{ extract_workflow_name.choices.0.message.content }}': {{ run_workflow.error }}"
      thread_ts: "{{ event.thread_ts or event.timestamp }}"