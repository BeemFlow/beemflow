# Event Bot - AI-Powered Event Assistant
#
# Answers guest questions via SMS using event details from a Google Doc
# Simply edit the Google Doc to update event information - no redeployment needed!
# Tracks all conversations in Google Sheets for organizer review
#
# Setup Instructions:
# 1. Create a Google Doc with your event details (parking, venue, schedule, etc.)
#    - Get the doc ID from URL: https://docs.google.com/document/d/[DOC_ID]/edit
#    - Update event_doc_id variable below
# 2. Create a Google Sheet for tracking conversations
#    - Add headers: Phone | Timestamp | Question | Response
#    - Get sheet ID from URL: https://docs.google.com/spreadsheets/d/[SHEET_ID]/edit
#    - Update rsvp_sheet_id variable below
# 3. Set environment variables: TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, ANTHROPIC_API_KEY
# 4. Authorize Google OAuth: beemflow oauth authorize google
# 5. Deploy: beemflow flows deploy eventbot
# 6. Configure Twilio webhook to: POST https://your-domain.com/webhooks/twilio

name: eventbot
description: AI-powered event assistant for SMS - Uses Google Docs for event details
version: 2.1.0
on:
  webhook:
    topic: twilio.sms

vars:
  # === REQUIRED CONFIGURATION ===

  event_doc_id: "1JlekaIKFAIXPu5UZL4XyOr5RcCT-zWY8GQZzzTuB3o8"
  # Google Doc with event details
  # URL: https://docs.google.com/document/d/1JlekaIKFAIXPu5UZL4XyOr5RcCT-zWY8GQZzzTuB3o8/edit

  rsvp_sheet_id: "1LxQHkyV-pNwKJJEkuO04pUN8gzSbjkyOHx5-Nlw9FaQ"
  # Google Sheet for tracking conversations
  # URL: https://docs.google.com/spreadsheets/d/1LxQHkyV-pNwKJJEkuO04pUN8gzSbjkyOHx5-Nlw9FaQ/edit

steps:
  # ============================================================================
  # STEP 1: Parse Incoming SMS
  # ============================================================================
  - id: parse_sms
    use: core.echo
    with:
      guest_phone: "{{ event.From }}"
      guest_message: "{{ event.Body }}"
      bot_number: "{{ event.To }}"
      message_sid: "{{ event.MessageSid }}"

  # ============================================================================
  # STEP 2: Fetch Event Details from Google Doc
  # ============================================================================
  - id: fetch_event_doc
    use: google_docs.get
    with:
      documentId: "{{ vars.event_doc_id }}"
    auth:
      oauth: "google:default"

  # ============================================================================
  # STEP 3: Generate Response using Claude
  # ============================================================================
  - id: generate_response
    use: anthropic.chat_completion
    with:
      model: "claude-3-5-sonnet-20241022"
      max_tokens: 500
      temperature: 0.7
      system: |
        You are a helpful, friendly event assistant for an event.

        Your role:
        - Answer guest questions about the event using the details below
        - Respond to greetings in a friendly way
        - Keep responses concise (under 300 characters when possible - SMS best practice)
        - Be warm, professional, and helpful

        If a guest:
        - Asks a question: Answer from event details below
        - Says thanks: Respond kindly
        - Says hi: Greet them and offer help
        - Asks something not covered: Politely say you'll have the organizer reach out

        EVENT DETAILS (from Google Doc):
        {{ steps.fetch_event_doc }}

        Important:
        - Use emoji sparingly (only 1-2 per message)
        - Don't use overly formal language
        - Sign off with a simple closing like "See you there!" or "Let us know if you need anything else!"
      messages:
        - role: user
          content: "{{ steps.parse_sms.guest_message }}"

  # ============================================================================
  # STEP 4: Log Conversation to Google Sheets
  # ============================================================================
  - id: log_conversation
    use: google_sheets.values.append
    with:
      spreadsheetId: "{{ vars.rsvp_sheet_id }}"
      range: "Sheet1!A:D"
      values:
        - - "{{ steps.parse_sms.guest_phone }}"
          - "{{ steps.parse_sms.message_sid }}"
          - "{{ steps.parse_sms.guest_message }}"
          - "{{ steps.generate_response.content[0].text }}"
    auth:
      oauth: "google:default"

  # ============================================================================
  # STEP 5: Send SMS Response
  # ============================================================================
  - id: send_sms
    use: twilio.send_sms
    with:
      AccountSid: "{{ secrets.TWILIO_ACCOUNT_SID }}"
      To: "{{ steps.parse_sms.guest_phone }}"
      From: "{{ steps.parse_sms.bot_number }}"
      Body: "{{ steps.generate_response.content[0].text }}"

  # ============================================================================
  # STEP 6: Return Success Summary
  # ============================================================================
  - id: complete
    use: core.echo
    with:
      status: "success"
      guest_phone: "{{ steps.parse_sms.guest_phone }}"
      response_sent: true
      conversation_logged: true

# ============================================================================
# EXAMPLE CONVERSATIONS
# ============================================================================
#
# Conversation 1: Parking Question
# Guest: "Where can I park?"
# Bot: "You can park on-site for free at Riverside Gardens! Valet service is
#      also available for $10. Shuttles run between downtown hotels and the
#      venue too. See you there!"
#
# Conversation 2: Hotel Question
# Guest: "What's the hotel discount code?"
# Bot: "The hotel block is at Riverside Inn with code SARAH-JOHN-2025 for
#      $149/night. Book by May 15th! Let us know if you need anything else!"
#
# Conversation 3: Greeting
# Guest: "Hi!"
# Bot: "Hi! Thanks for reaching out. I'm here to help with any questions about
#      Sarah & John's wedding - parking, hotels, schedule, or anything else!"
#
# ============================================================================
# GOOGLE SHEETS SETUP
# ============================================================================
#
# Create a spreadsheet titled "Sarah & John Wedding Tracking"
#
# Tab: "Questions" (Conversation Log)
# Headers: Phone | Timestamp | Question | Response
#
# ============================================================================
# DEPLOYMENT CHECKLIST
# ============================================================================
#
# [ ] Create Google Sheet with "Questions" tab
# [ ] Set up Twilio account and purchase phone number
# [ ] Configure environment variables (TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, ANTHROPIC_API_KEY)
# [ ] Update vars in this file with your sheet ID
# [ ] Deploy workflow: beemflow flows deploy eventbot
# [ ] Configure Twilio webhook: POST https://your-domain.com/webhooks/twilio
# [ ] Test with real SMS messages
#
# ============================================================================
