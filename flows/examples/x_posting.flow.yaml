name: x_posting
on: schedule.cron
cron: "0 9 * * *"  # Run daily at 9 AM

vars:
  DRIVE_FOLDER: "{{ secrets.GOOGLE_DRIVE_FOLDER_ID }}"
  SHEETS_ID: "{{ secrets.GOOGLE_SHEETS_ID }}"

steps:
  # Get files from Drive
  - id: drive_files
    use: google_drive.files.list
    with:
      q: "parents in '{{ DRIVE_FOLDER }}' and trashed=false"
      orderBy: "createdTime desc"
      pageSize: 5

  # Get current sheet data
  - id: sheet_data
    use: google_sheets.values.get
    with:
      spreadsheetId: "{{ SHEETS_ID }}"
      range: "Sheet1!A:F"

  # Add new files to sheet (if not already there)
  - id: add_new_files
    foreach: "{{ drive_files.files }}"
    as: file
    do:
      - id: generate_tweet
        use: openai.chat_completion
        with:
          model: "gpt-4o-mini"
          messages:
            - role: user
              content: "Create a tweet (under 280 chars) for this file: {{ file.name }}"
      
      - id: add_to_sheet
        use: google_sheets.values.append
        with:
          spreadsheetId: "{{ SHEETS_ID }}"
          range: "Sheet1!A:F"
          valueInputOption: "USER_ENTERED"
          values:
            - - "{{ file.name }}"
              - "{{ file.webViewLink }}"
              - "{{ generate_tweet.choices.0.message.content }}"
              - "pending"
              - ""
              - ""

  # Post approved tweets
  - id: post_tweets
    foreach: "{{ sheet_data.values }}"
    as: row
    do:
      - id: post_if_approved
        if: "{{ row | length >= 5 and row[4] | lower == 'yes' and (row[5] == '' or not row[5]) }}"
        use: x.post
        with:
          text: "{{ row[2] }}"
      
      - id: mark_posted
        if: "{{ row | length >= 5 and row[4] | lower == 'yes' and (row[5] == '' or not row[5]) }}"
        use: google_sheets.values.update
        with:
          spreadsheetId: "{{ SHEETS_ID }}"
          range: "Sheet1!F{{ row_row }}"
          valueInputOption: "USER_ENTERED"
          values:
            - - "{{ post_if_approved.data.id if post_if_approved.data else 'posted' }}"